---
import BaseLayout from '../layouts/BaseLayout.astro';
import BackButton from '../components/BackButton.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import data from '../../data.json';
import affiliatesData from '../data/affiliates.json';
import { createSlug, generateTitle, generatePrompt, capitalize } from '../utils/helpers';

export async function getStaticPaths() {
  const { profesiones, estilos, acciones } = data;
  
  // Generate all possible combinations using flatMap
  const paths = profesiones.flatMap((profesion) =>
    estilos.flatMap((estilo) =>
      acciones.map((accion) => {
        const slug = `${createSlug(profesion)}-${createSlug(estilo)}-${createSlug(accion)}`;
        const title = generateTitle(profesion, estilo, accion);
        const prompt = generatePrompt(profesion, estilo, accion);
        
        return {
          params: { slug },
          props: {
            profesion,
            estilo,
            accion,
            title,
            prompt,
          },
        };
      })
    )
  );

  return paths;
}

interface Props {
  profesion: string;
  estilo: string;
  accion: string;
  title: string;
  prompt: string;
}

const { profesion, estilo, accion, title, prompt } = Astro.props;

// Generate description from props
const description = `Generate professional AI images of ${profesion} ${estilo} ${accion}. Optimized prompt: ${prompt}. Create high-quality photos for professional use.`;

// Generate breadcrumbs for navigation
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: capitalize(profesion), href: '#' },
  { label: capitalize(estilo), href: '#' },
  { label: capitalize(accion), href: '#' }
];

// Generate related prompts (6 random combinations excluding current)
function getRelatedPrompts(currentProfesion: string, currentEstilo: string, currentAccion: string) {
  const { profesiones, estilos, acciones } = data;
  const currentSlug = `${createSlug(currentProfesion)}-${createSlug(currentEstilo)}-${createSlug(currentAccion)}`;
  
  // Generate all possible combinations
  const allCombinations: Array<{profesion: string, estilo: string, accion: string, slug: string, title: string}> = [];
  
  profesiones.forEach((p) => {
    estilos.forEach((e) => {
      acciones.forEach((a) => {
        const slug = `${createSlug(p)}-${createSlug(e)}-${createSlug(a)}`;
        // Exclude current combination
        if (slug !== currentSlug) {
          allCombinations.push({
            profesion: p,
            estilo: e,
            accion: a,
            slug,
            title: generateTitle(p, e, a)
          });
        }
      });
    });
  });
  
  // Shuffle and take 6 random combinations
  const shuffled = [...allCombinations].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, 6);
}

const relatedPrompts = getRelatedPrompts(profesion, estilo, accion);

// Generate structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "author": {
    "@type": "Organization",
    "name": "Smart Prompt Guide"
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": breadcrumbs.map((item, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": item.label,
      "item": item.href === '#' ? Astro.url.href : new URL(item.href, Astro.url.origin).href
    }))
  }
};

// Map priority categories to English style/action/profession values
const categoryMap: Record<string, string[]> = {
  'business': ['business', 'corporate', 'executive', 'entrepreneur'],
  'office': ['office'],
  'realistic': ['photorealistic', 'realistic'],
  'professional': ['professional'],
  'portrait': ['portrait', 'portraits', 'photographer'],
  'photography': ['photography', 'photographer', 'photographic'],
  'cyberpunk': ['cyberpunk'],
  'fantasy': ['fantasy', 'artistic', 'creative'],
  'anime': ['anime', 'artistic'],
  'artistic': ['artistic', 'art', 'creative', 'studio'],
  'futuristic': ['futuristic'],
  'digital': ['digital', 'digitally'],
  '3d': ['3d', '3-d', 'three-dimensional']
};

// Normalize text for comparison
function normalizeForComparison(text: string): string {
  return text.toLowerCase().trim();
}

// Check if any current tags match priority categories
function getAffiliatePriority(affiliate: typeof affiliatesData[0]): number {
  const currentTags = [
    normalizeForComparison(profesion),
    normalizeForComparison(estilo),
    normalizeForComparison(accion)
  ];
  
  // Check each priority category
  for (const priorityCategory of affiliate.priorityCategories) {
    const mappedValues = categoryMap[priorityCategory] || [priorityCategory];
    
    // Check if any mapped value matches current tags
    for (const mappedValue of mappedValues) {
      const normalizedMapped = normalizeForComparison(mappedValue);
      if (currentTags.some(tag => tag.includes(normalizedMapped) || normalizedMapped.includes(tag))) {
        return 1; // High priority (has match)
      }
    }
  }
  
  return 0; // Low priority (no match)
}

// Sort affiliates by priority (matching ones first)
const sortedAffiliates = [...affiliatesData].sort((a, b) => {
  const priorityA = getAffiliatePriority(a);
  const priorityB = getAffiliatePriority(b);
  return priorityB - priorityA; // Higher priority first
});

// Helper function to get color classes
function getColorClasses(color: string, isHover: boolean = false) {
  const colorMap: Record<string, { bg: string; hover: string; text: string; border: string }> = {
    purple: {
      bg: 'bg-purple-100',
      hover: 'group-hover:bg-purple-200',
      text: 'text-purple-600',
      border: 'hover:border-purple-500'
    },
    indigo: {
      bg: 'bg-indigo-100',
      hover: 'group-hover:bg-indigo-200',
      text: 'text-indigo-600',
      border: 'hover:border-indigo-500'
    },
    red: {
      bg: 'bg-red-100',
      hover: 'group-hover:bg-red-200',
      text: 'text-red-600',
      border: 'hover:border-red-500'
    },
    blue: {
      bg: 'bg-blue-100',
      hover: 'group-hover:bg-blue-200',
      text: 'text-blue-600',
      border: 'hover:border-blue-500'
    }
  };
  
  const colors = colorMap[color] || colorMap.blue;
  return isHover ? colors.hover : colors.bg;
}

function getTextColor(color: string) {
  const colorMap: Record<string, string> = {
    purple: 'group-hover:text-purple-600',
    indigo: 'group-hover:text-indigo-600',
    red: 'group-hover:text-red-600',
    blue: 'group-hover:text-blue-600'
  };
  return colorMap[color] || colorMap.blue;
}

function getIconColor(color: string) {
  const colorMap: Record<string, string> = {
    purple: 'text-purple-600',
    indigo: 'text-indigo-600',
    red: 'text-red-600',
    blue: 'text-blue-600'
  };
  return colorMap[color] || colorMap.blue;
}
---

<BaseLayout title={title} description={description}>
  {/* Structured Data for SEO */}
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
    <main class="max-w-4xl mx-auto px-6 pt-8 pb-16 sm:pt-12 sm:pb-24">
      <!-- Navigation -->
      <BackButton />
      <Breadcrumbs items={breadcrumbs} />

      <!-- Header -->
      <div class="mb-12">
        <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 mb-4 leading-tight">
          {title}
        </h1>
        <p class="text-lg text-gray-600">
          Smart Prompt Guide - Professional AI image generator
        </p>
      </div>

      <!-- Prompt Section -->
      <div class="bg-gray-900 rounded-lg p-6 sm:p-8 shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <div class="flex gap-1.5">
              <span class="w-3 h-3 rounded-full bg-red-500"></span>
              <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
              <span class="w-3 h-3 rounded-full bg-green-500"></span>
            </div>
            <span class="text-gray-400 text-sm font-mono ml-2">terminal</span>
          </div>
          <button
            id="copyButton"
            class="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded-lg transition-all duration-200 text-sm font-medium group"
            data-prompt={prompt}
          >
            <svg id="copyIcon" class="w-4 h-4 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <svg id="checkIcon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="copyButtonText">Copy</span>
          </button>
        </div>
        
        <div class="font-mono text-sm sm:text-base">
          <div class="text-gray-400 mb-2">
            <span class="text-green-400">$</span> prompt
          </div>
          <div id="promptText" class="text-gray-100 leading-relaxed whitespace-pre-wrap break-words">
            {prompt}
          </div>
        </div>
      </div>

      <script>
        const copyButton = document.getElementById('copyButton');
        const copyButtonText = document.getElementById('copyButtonText');
        const promptText = document.getElementById('promptText');
        const copyIcon = document.getElementById('copyIcon');
        const checkIcon = document.getElementById('checkIcon');
        
        if (copyButton && promptText) {
          copyButton.addEventListener('click', async () => {
            const textToCopy = promptText.textContent || promptText.innerText;
            
            try {
              await navigator.clipboard.writeText(textToCopy);
              
              // Update button UI
              const originalText = copyButtonText.textContent;
              copyButtonText.textContent = 'Copied!';
              copyIcon.classList.add('hidden');
              checkIcon.classList.remove('hidden');
              copyButton.classList.add('bg-green-600', 'hover:bg-green-700');
              copyButton.classList.remove('bg-gray-800', 'hover:bg-gray-700');
              
              // Reset after 2 seconds
              setTimeout(() => {
                copyButtonText.textContent = originalText;
                copyIcon.classList.remove('hidden');
                checkIcon.classList.add('hidden');
                copyButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                copyButton.classList.add('bg-gray-800', 'hover:bg-gray-700');
              }, 2000);
            } catch (err) {
              // Fallback for older browsers
              const textArea = document.createElement('textarea');
              textArea.value = textToCopy;
              textArea.style.position = 'fixed';
              textArea.style.opacity = '0';
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              
              // Update button UI
              copyButtonText.textContent = 'Copied!';
              copyIcon.classList.add('hidden');
              checkIcon.classList.remove('hidden');
              copyButton.classList.add('bg-green-600', 'hover:bg-green-700');
              copyButton.classList.remove('bg-gray-800', 'hover:bg-gray-700');
              
              setTimeout(() => {
                copyButtonText.textContent = 'Copy';
                copyIcon.classList.remove('hidden');
                checkIcon.classList.add('hidden');
                copyButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                copyButton.classList.add('bg-gray-800', 'hover:bg-gray-700');
              }, 2000);
            }
          });
        }
      </script>

      <!-- Recommended Tools Section -->
      <div class="mt-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
          ðŸ§° Recommended Tools
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {sortedAffiliates.map((affiliate) => {
            // Get icon based on affiliate ID
            const getIcon = () => {
              if (affiliate.id === 'getimg' || affiliate.id === 'leonardo') {
                return (
                  <svg class={`w-6 h-6 ${getIconColor(affiliate.color)}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                );
              } else if (affiliate.id === 'magnific') {
                return (
                  <svg class={`w-6 h-6 ${getIconColor(affiliate.color)}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                  </svg>
                );
              } else {
                return (
                  <svg class={`w-6 h-6 ${getIconColor(affiliate.color)}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                );
              }
            };

            const borderColor = affiliate.color === 'purple' ? 'hover:border-purple-500' : 
                               affiliate.color === 'indigo' ? 'hover:border-indigo-500' :
                               affiliate.color === 'red' ? 'hover:border-red-500' : 
                               'hover:border-blue-500';

            return (
              <a
                href={affiliate.url}
                target="_blank"
                rel="nofollow sponsored"
                class={`group p-4 bg-white rounded-lg border-2 border-gray-200 ${borderColor} transition-all duration-200 hover:shadow-lg`}
              >
                <div class="flex items-start gap-3">
                  <div class={`w-10 h-10 rounded-lg ${getColorClasses(affiliate.color)} flex items-center justify-center flex-shrink-0 ${getColorClasses(affiliate.color, true)} transition-colors`}>
                    {getIcon()}
                  </div>
                  <div class="flex-1">
                    <h3 class={`font-semibold text-gray-900 mb-1 ${getTextColor(affiliate.color)} transition-colors`}>
                      {affiliate.badge}
                    </h3>
                    <p class="text-sm text-gray-600">
                      {affiliate.name}
                    </p>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </div>

      <!-- Info Section -->
      <div class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">
          How to use this prompt
        </h2>
        <p class="text-gray-700 leading-relaxed">
          Copy the prompt above and use it in your favorite AI image generator 
          (Midjourney, DALL-E, Stable Diffusion, etc.) to create high-quality 
          professional images.
        </p>
      </div>

      <!-- Metadata Section -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="p-4 bg-white rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500 mb-1">Profession</div>
          <div class="font-semibold text-gray-900 capitalize">{profesion}</div>
        </div>
        <div class="p-4 bg-white rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500 mb-1">Style</div>
          <div class="font-semibold text-gray-900 capitalize">{estilo}</div>
        </div>
        <div class="p-4 bg-white rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500 mb-1">Action</div>
          <div class="font-semibold text-gray-900 capitalize">{accion}</div>
        </div>
      </div>

      <!-- Related Prompts Section -->
      <div class="mt-16">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">
          Try these other styles
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {relatedPrompts.map((related) => (
            <a
              href={`/${related.slug}`}
              class="block p-4 bg-white rounded-lg border border-gray-200 hover:border-gray-300 hover:shadow-md transition-all duration-200 group"
            >
              <h3 class="font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors line-clamp-2">
                {related.title.split('|')[0].trim()}
              </h3>
              <div class="flex flex-wrap gap-2 mt-2">
                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded capitalize">
                  {related.profesion}
                </span>
                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded capitalize">
                  {related.estilo}
                </span>
                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded capitalize">
                  {related.accion}
                </span>
              </div>
            </a>
          ))}
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-16 pt-8 border-t border-gray-200">
        <p class="text-sm text-gray-500 text-center">
          Smart Prompt Guide - Professional AI image prompt generator
        </p>
      </footer>
    </main>
  </div>
</BaseLayout>
